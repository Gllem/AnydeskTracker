@{
    Layout = "_Layout";
    ViewData["Title"] = "–ê–¥–º–∏–Ω–∫–∞ –º–µ—Ç—Ä–∏–∫–∞";
    var node = Model?.Data?.Tree?.FirstOrDefault();
}

@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@model AnydeskTracker.DTOs.YandexApiResponse

<div class="container py-3">
    <label class="form-label">–ü–µ—Ä–∏–æ–¥</label> <!-- TODO: –í–´–Ω–µ—Å—Ç–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –±–ª–æ–∫-->
    <select class="form-select period-select" id="period-select">
        @foreach (var period in node.Period)
        {
            <option value="@period.Key">@period.Value</option>
        }
    </select>
    <!-- üîΩ –ë–ª–æ–∫ —Å –¥—Ä–æ–ø–¥–∞—É–Ω–∞–º–∏ (DimensionFields) -->
    <div class="card mb-3">
        <div class="card-header fw-bold">
            –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–∞–∑—Ä–µ–∑–∞
        </div>
        <div class="card-body">
            <div class="row g-3">

                <div class="col-md-4">
                    @if (node?.DimensionFields != null)
                    {
                        foreach (var dim in node.DimensionFields)
                        {
                            <label class="form-label">@dim.Title</label>

                            @if (dim.Values != null && dim.Values.Any())
                            {
                                <select class="form-select dimension-select"
                                        data-dimension-id="@dim.Id">
                                    <option value="">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</option>
                                    @foreach (var v in dim.Values)
                                    {
                                        <option value="@v[0]">@v[1]</option>
                                    }
                                </select>
                            }
                            else
                            {
                                <input class="form-control" placeholder="–ù–µ—Ç –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤" disabled/>
                            }
                        }
                    }
                    else
                    {
                        <div class="text-muted">–ù–µ—Ç dimension fields</div>
                    }


                </div>

            </div>
        </div>
    </div>

    <!-- ‚òëÔ∏è –ë–ª–æ–∫ —Å —á–µ–∫–±–æ–∫—Å–∞–º–∏ (Fields) -->
    <div class="card">
        <div class="card-header fw-bold">
            –ü–æ–ª—è –º–µ—Ç—Ä–∏–∫
        </div>
        <div class="card-body">

            <div class="row g-2">

                @if (node?.Fields != null)
                {
                    foreach (var field in node.Fields)
                    {
                        <div class="col-md-4 col-lg-3">
                            <div class="form-check">
                                <input class="form-check-input metric-checkbox"
                                       type="checkbox"
                                       value="@field.Id"
                                       id="field_@field.Id"
                                       data-category="@field.CategoryName"/>

                                <label class="form-check-label" for="field_@field.Id">
                                    @field.Title
                                </label>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="text-muted">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–æ–ª–µ–π</div>
                }

            </div>

        </div>
    </div>

    <div class="mt-3">
        <button id="buildRequest" class="btn btn-primary">
            –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –∑–∞–ø—Ä–æ—Å
        </button>
    </div>
    <style>
        #resultTable th,
        #resultTable td {
            white-space: nowrap;
        }

        #resultTable td:last-child,
        #resultTable th:last-child {
            max-width: 350px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-align: left;
        }

        #resultTable th:not(:last-child),
        #resultTable td:not(:last-child) {
            width: 120px;
            text-align: left;
        }
    </style>
    <div class="table-responsive">
        <table class="table table-bordered table/compiler table-striped" id="resultTable">
            <thead></thead>
            <tbody></tbody>
        </table>
    </div>

</div>

@section Scripts
{
    <script>
        $(function () {

            $("#buildRequest").on("click", async function () {

                const dimensions = {};
                $(".dimension-select").each(function () {
                    dimensions[$(this).data("dimension-id")] = $(this).val();
                });

                const fields = [];
                $(".metric-checkbox:checked").each(function () {
                    fields.push($(this).val());
                });

                const period = $("#period-select").val();

                const response = await fetch("/Admin/Metrika/Build", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        dimensions: dimensions,
                        fields: fields,
                        period: period
                    })
                });

                if (!response.ok) {
                    alert("–û—à–∏–±–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –æ—Ç—á–µ—Ç–∞");
                    return;
                }

                const data = await response.json();

                const table = $("#resultTable");
                const thead = table.find("thead");
                const tbody = table.find("tbody");


                thead.empty();
                tbody.empty();

                // –ó–∞–≥–æ–ª–æ–≤–∫–∏
                let headRow = "<tr>";
                data.columnTitles.forEach(title => {
                    headRow += `<th>${title}</th>`;
                });
                headRow += "</tr>";
                thead.append(headRow);

// –°—Ç—Ä–æ–∫–∏
                data.rows.forEach((row, index) => {
                    let tr = index === 0
                        ? "<tr class='table-success fw-bold'>"
                        : "<tr>";

                    data.columnKeys.forEach(key => {
                        tr += `<td>${row[key] ?? ""}</td>`;
                    });

                    tr += "</tr>";
                    tbody.append(tr);
                });
            });

        });
    </script>
}