@{
    Layout = "_Layout";
    ViewData["Title"] = "–ê–¥–º–∏–Ω–∫–∞ –º–µ—Ç—Ä–∏–∫–∞";
    var node = Model?.Data?.Tree?.FirstOrDefault();
}

@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@model AnydeskTracker.DTOs.YandexApiResponse

<div class="container py-3">
    <div class="btn-group mb-3" role="group" aria-label="Period select">
        @foreach (var item in node.Period)
        {
            <input type="radio"
                   class="btn-check"
                   name="period"
                   id="period_@item.Key"
                   value="@item.Key"
                   autocomplete="off"
                   @(item.Key == "today" ? "checked" : "")/>

            <label class="btn btn-outline-secondary" for="period_@item.Key"
                   title="@item.Value">
                @item.Value
            </label>
        }
    </div>
    <!-- üîΩ –ë–ª–æ–∫ —Å –¥—Ä–æ–ø–¥–∞—É–Ω–∞–º–∏ (DimensionFields) -->
    <div class="card mb-3">
        <div class="card-header fw-bold">
            –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–∞–∑—Ä–µ–∑–∞
        </div>
        <div class="card-body">
            <div class="row g-3">

                <div class="col-md-12">
                    @if (node?.DimensionFields != null)
                    {
                        @foreach (var dim in node.DimensionFields)
                        {
                            <div class="row align-items-center mb-2">
                                <div class="col-12 col-md-1.5">
                                    <div class="form-label fw-semibold mb-0">@dim.Title</div>
                                </div>

                                <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –∫–Ω–æ–ø–∫–∏ -->
                                <div class="col-12 col-md-10">
                                    <div class="btn-group flex-wrap" role="group" aria-label="@dim.Title">

                                        <input type="radio"
                                               class="btn-check dimension-select"
                                               name="dimension_@dim.Id"
                                               id="dim_@dim.Id"
                                               value=""
                                               autocomplete="off"
                                               checked />

                                        <label class="btn btn-outline-secondary btn-sm"
                                               for="dim_@dim.Id">
                                            –ù–∏—á–µ–≥–æ
                                        </label>
                                        
                                        @foreach (var v in dim.Values)
                                        {
                                            var valueKey = v[0];
                                            var valueTitle = v[1];

                                            <input type="radio"
                                                   class="btn-check dimension-select"
                                                   name="dimension_@dim.Id"
                                                   id="dim_@dim.Id@valueKey"
                                                   value="@valueKey"
                                                   autocomplete="off"/>

                                            <label class="btn btn-outline-secondary btn-sm"
                                                   for="dim_@dim.Id@valueKey">
                                                @valueTitle
                                            </label>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="text-muted">–ù–µ—Ç dimension fields</div>
                    }
                </div>

            </div>
        </div>
    </div>

    <!-- ‚òëÔ∏è –ë–ª–æ–∫ —Å —á–µ–∫–±–æ–∫—Å–∞–º–∏ (Fields) -->
    <div class="card">
        <div class="card-header fw-bold">
            –ü–æ–ª—è –º–µ—Ç—Ä–∏–∫
        </div>
        <div class="card-body">

            <div class="row g-2">

                @if (node?.Fields != null)
                {
                    foreach (var field in node.Fields)
                    {
                        <div class="col-md-4 col-lg-3">
                            <div class="form-check">
                                <input class="form-check-input metric-checkbox"
                                       type="checkbox"
                                       value="@field.Id"
                                       id="field_@field.Id"
                                       data-category="@field.CategoryName"/>

                                <label class="form-check-label" for="field_@field.Id">
                                    @field.Title
                                </label>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="text-muted">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–æ–ª–µ–π</div>
                }

            </div>

        </div>
    </div>

    <div class="mt-3">
        <button id="buildRequest" class="btn btn-primary">
            –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –∑–∞–ø—Ä–æ—Å
        </button>
    </div>
    <style>
        #resultTable th,
        #resultTable td {
            white-space: nowrap;
        }

        #resultTable td:last-child,
        #resultTable th:last-child {
            max-width: 350px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-align: left;
        }

        #resultTable th:not(:last-child),
        #resultTable td:not(:last-child) {
            width: 120px;
            text-align: left;
        }
    </style>
    <div class="table-responsive">
        <table class="table table-bordered table/compiler table-striped" id="resultTable">
            <thead></thead>
            <tbody></tbody>
        </table>
    </div>

</div>

@section Scripts
{
    <script>
        $(function () {

            $("#buildRequest").on("click", async function () {

                const dimensions = {};

                $('input.dimension-select:checked').each(function () {
                    const name = $(this).attr('name');
                    const dimId = name.replace('dimension_', '');
                    dimensions[dimId] = $(this).val();
                });

                const fields = [];
                $(".metric-checkbox:checked").each(function () {
                    fields.push($(this).val());
                });

                const period = $('input[name="period"]:checked').val();

                const response = await fetch("/Admin/Metrika/Build", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        dimensions: dimensions,
                        fields: fields,
                        period: period
                    })
                });

                if (!response.ok) {
                    alert("–û—à–∏–±–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –æ—Ç—á–µ—Ç–∞");
                    return;
                }

                const data = await response.json();

                const table = $("#resultTable");
                const thead = table.find("thead");
                const tbody = table.find("tbody");


                thead.empty();
                tbody.empty();

                // –ó–∞–≥–æ–ª–æ–≤–∫–∏
                let headRow = "<tr>";
                data.columnTitles.forEach(title => {
                    headRow += `<th>${title}</th>`;
                });
                headRow += "</tr>";
                thead.append(headRow);

// –°—Ç—Ä–æ–∫–∏
                data.rows.forEach((row, index) => {
                    let tr = index === 0
                        ? "<tr class='table-success fw-bold'>"
                        : "<tr>";

                    data.columnKeys.forEach(key => {
                        tr += `<td>${row[key] ?? ""}</td>`;
                    });

                    tr += "</tr>";
                    tbody.append(tr);
                });
            });

        });
    </script>
}