@{
    Layout = "_Layout";
    ViewData["Title"] = "Пользователь";
}
@using AnydeskTracker.Extensions
@model AnydeskTracker.DTOs.AdminUserPageDto

<div class="w-100 h-100 d-flex flex-row">
    <div class="col-3 px-1">
        <h4 class="text-truncate">@Model.UserEmail</h4>
        <form id="changeUserInfo" class="mb-3 d-flex gap-3" style="height: 3em">
            <input id="user_name" type="text" placeholder="Имя юзера" class="form-control" required />
            <button class="btn btn-success">Поменять</button>
        </form>
        <div class="d-flex flex-column gap-3">
            @foreach (var workSession in Model.WorkSessions.Reverse())
            {
                <button class="btn btn-outline-secondary" onclick="loadActionsButtonClick(@workSession.Id)">
                    Смена от
                    <br>
                    <strong class="utc-time" data-time="@workSession.StartTime.ToUtc().ToString("o")"></strong>
                </button>
            }
        </div>
    </div>
    <div class="col-9 px-1">
        <table class="table table-bordered rounded-3" id="userActions">
            <thead>
            <tr>
                <th>Действие</th>
                <th>Описание</th>
                <th>Время</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

@section Scripts
{
    <script>
        ConvertAllToLocalTime(document);
        document.getElementById('user_name').value = "@Model.UserName";
        
        function loadActionsButtonClick(sessionId){
            location.hash = sessionId;
            loadActions(sessionId)
        }
        
        async function loadActions(sessionId)
        {
            const res = await fetch(`/api/admin/user/@Model.UserId/${sessionId}/actions`);
            const data = await res.json();
            const tbody = document.querySelector('#userActions tbody');
            tbody.innerHTML = data.map(userAction => `
                <tr>
                    <td>${userAction.actionType}</td>
                    <td>${userAction.description}</td>
                    <td>${localTime(userAction.timestamp)}</td>
                </tr>
            `).join('');
        }
        
        function loadActionsFromHash(){
            const id = location.hash.replace('#', '');
            if (id)
                loadActions(id);
        }

        document.getElementById('changeUserInfo').addEventListener('submit', async (e) => {
            e.preventDefault();
            const userName = document.getElementById('user_name').value;
            const userId = "@Model.UserId";
            const workSessions = null;
            const res = await fetch('/api/admin/user/@Model.UserId', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userName, userId, workSessions })
            });
            if (!res.ok)
            {
                alert("Ошибка при обновлении пользователя");
                return;
            }
            window.location.href = "";
        });
        
        window.addEventListener('load', loadActionsFromHash);
        window.addEventListener('hashchange', loadActionsFromHash);
    </script>
}
