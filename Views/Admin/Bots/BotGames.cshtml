@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@{
    Layout = "_Layout";
    ViewData["Title"] = "Игры ботов";
}
@model AnydeskTracker.DTOs.AdminBotGamesDto


<div class="w-100 h-100 d-flex flex-row justify-content-between">
    <div class="col-3 px-1 d-flex flex-column gap-3 pe-3">
        <button data-id="" class="botButton btn btn-outline-primary fw-bold w-100" onclick="loadPcGamesButtonClick('')">
            Общий список
        </button>
        <div class="d-grid gap-2 justify-content-between" style="grid-template-columns: repeat(2, 49%)">
            @foreach (var pc in Model.Pcs)
            {
                <button data-id="@pc.Id" class="botButton btn btn-outline-secondary text-truncate fw-bold position-relative" onclick="loadPcGamesButtonClick(@pc.Id)">
                    @pc.DisplayId
                    <span class="pc-dot position-absolute top-0 end-0 m-1 p-1 bg-danger rounded-circle @(pc.HasOverridenGames ? "" : "d-none")"></span>
                </button>
            }
        </div>
    </div>
    <div class="col-9 px-1">
        <div id="addForm" class="mb-3 d-flex justify-content-between gap-3">
            <button class="btn btn-success col-2" onclick="addGame()">Добавить Игру</button>
            <select id="gameSelect" class="form-select w-auto flex-grow-1">
                <option value="">-- выберите игру --</option>
                @foreach (var game in Model.Games)
                {
                    var gameName = !string.IsNullOrEmpty(game.Name) ? game.Name : game.Url;
                    <option value="@game.Id" data-name="@gameName">@gameName</option>
                }
            </select>
            <button class="btn btn-secondary" onclick="downloadBotGames()">Скачать список</button>
        </div>

        <button id="saveBtn" class="btn btn-secondary col-12 mb-3">Сохранить очередность</button>

        <table class="table table-bordered" id="gamesTable">
            <thead>
            <tr>
                <th style="width: 30px"></th>
                <th style="width: 30px" class="text-center">ID</th>
                <th>Игра</th>
                <th class="col-1"></th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

@section Scripts
{
    <!-- Table updating && left buttons -->
    <script>
        let currentPcId = '';
        let currentBotId = '';
        const saveBtn = $('#saveBtn');
        
        function loadPcGamesButtonClick(pcId){
            location.hash = pcId;
            loadPcGames(pcId)
        }
        
        async function loadPcGames(pcId)
        {
            currentPcId = pcId;
            
            const res = await fetch(`/api/admin/bots/games/${pcId}`);
            const data = await res.json();
            const tbody = document.querySelector('#gamesTable tbody');
            
            tbody.innerHTML = data.map(botGame => {
                const gameName = botGame.name ? botGame.name : botGame.url;
                return `
                    <tr data-id="${botGame.id}" data-order="${botGame.order}">
                        <td class="drag-handle text-muted text-center">
                          ☰
                        </td>
                        <td class="orderTd text-center">${botGame.order === 0 ? "" : botGame.order}</td>
                        <td><a href="${botGame.url}" target="_blank" rel="noopener noreferrer">${gameName}</a></td>
                        <td class="text-center"><button class="btn btn-sm btn-danger" onclick="deleteGame(${botGame.id})">Удалить</button></td>
                    </tr>
                `
            }).join('');

            setPcDot(pcId, data.length > 0);
            setLeftButtonsColor(pcId);
            saveBtn.removeClass("btn-primary").addClass("btn-secondary");
            syncSelectWithTable();
        }
        
        function loadActionsFromHash(){
            const id = location.hash.replace('#', '');
            loadPcGames(id);
        }

        function getTableIds() {
            return $('#gamesTable tbody tr')
                .map(function () {
                    return String($(this).data('id'));
                })
                .get();
        }

        function syncSelectWithTable() {
            const usedIds = new Set(getTableIds());

            $('#gameSelect option').each(function () {
                const opt = $(this);
                const val = opt.val();

                if (!val) 
                    return;

                if (usedIds.has(val)) {
                    opt.prop('disabled', true).addClass('d-none');
                } else {
                    opt.prop('disabled', false).removeClass('d-none');
                }
            });

            $('#gameSelect').val('');
        }

        async function addGame(){
            const gameId = document.getElementById('gameSelect').value;
            await fetch(`/api/admin/bots/games/${currentPcId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: gameId
            });
            await loadActionsFromHash();
        }

        async function deleteGame(gameId) {
            await fetch(`/api/admin/bots/games/${currentPcId}`, { 
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: gameId
            });
            await loadActionsFromHash();
        }

        function setPcDot(pcId, hasGames) {
            const btn = document.querySelector(`[data-id="${pcId}"]`);
            if (!btn) return;
            const dot = btn.querySelector('.pc-dot');
            if (!dot) return;
            dot.classList.toggle('d-none', !hasGames);
        }
        
        function setLeftButtonsColor(selectedPcId){
            $(`.botButton`).each(function () {
                $(this)
                    .removeClass('btn-outline-primary')
                    .addClass('btn-outline-secondary')
                
                if ($(this).attr("data-id") === selectedPcId)
                    $(this)
                        .removeClass('btn-outline-secondary')
                        .addClass('btn-outline-primary')
            });
        }
        
        async function downloadBotGames(){
            window.location.href = `/api/watchdog/botGamesId/${currentPcId}`;
        }
        
        window.addEventListener('load', loadActionsFromHash);
        window.addEventListener('hashchange', loadActionsFromHash);

        CustomTable("#gamesTable", () => `/api/admin/bots/games/bulk-update/${currentPcId}`, () => loadPcGames(currentPcId), false, true);
    </script>
}