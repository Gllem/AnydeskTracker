@{
    Layout = "_Layout";
    ViewData["Title"] = "Бот";
}
@using AnydeskTracker.Extensions
@model AnydeskTracker.DTOs.AdminBotPageDto
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers

<div class="w-100 h-100 d-flex flex-row">
    <div class="col-5 px-1">
        <h4 class="text-truncate">@Model.AnyDeskId</h4>
        <form id="changeBotInfo" class="mb-3 d-flex gap-3" style="height: 3em">
            <input id="bot_id" type="text" placeholder="ID Бота" class="form-control" required />
            <button class="btn btn-success">Поменять</button>
        </form>
        
        <div>
            <h5 class="mb-2">Статус бота</h5>
            <div class="d-flex flex-row text-center align-items-center justify-content-between">
                <div class="d-inline-flex align-items-center gap-1">
                    <span id="statusKnob" class="rounded-circle bg-secondary d-inline-block" style="width: 1em; height: 1em"></span>
                    <span id="statusText">
                        Статус
                    </span>
                </div>
                <a class="btn btn-danger" onclick="killApps()">
                    Отключить процессы
                </a>
            </div>
        </div>
       
        @if(Model.LastDolphinCheck != null)
        {
            <h5><b>Время последней проверки Dolphin:</b></h5>
            <h5 class="utc-time" data-time="@Model.LastDolphinCheck.Value.ToUtc().ToString("o")"></h5>
        }
        
        <div class="d-flex flex-column gap-3">
            @foreach (var botLog in Model.BotLogs.Reverse())
            {
                <button class="btn btn-outline-secondary" onclick="loadActionsButtonClick(`@botLog.LogDate`)">
                    Логи от <b>@botLog.LogDate</b><br/>
                    Проверок Dolphin <b>@botLog.DolphinChecks</b>
                </button>
            }
        </div>
    </div>
    <div class="col-7 px-1">
        <button id="btnWatchdog" class="btn btn-success">WatchDog</button>
        <button id="btnDolphin" class="btn btn-outline-success">Dolphin</button>
        
        <table class="table table-bordered rounded-3 mt-3" id="watchdogActions">
            <thead>
            <tr>
                <th>Проверка</th>
                <th>Ошибки</th>
                <th>Время</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>

        <table class="table table-bordered rounded-3 mt-3 d-none" id="dolphinActions">
            <thead>
            <tr>
                <th>Проверка</th>
                <th>Время</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

@section Scripts
{
    <script>
        ConvertAllToLocalTime(document);
        document.getElementById('bot_id').value = "@Model.BotId";
        const lastLogDate = "@(Model.BotLogs.Length > 0 ? Model.BotLogs.Reverse().First().LogDate : "")"

        function loadActionsButtonClick(date){
            location.hash = date;
            loadActions(date)
        }
        
        async function loadActions(date)
        {
            const res = await fetch(`/api/admin/bots/@Model.PcModelId/actions/${date}`);
            const data = await res.json();
            const watchdogTable = document.querySelector('#watchdogActions tbody');
            const dolphinTable = document.querySelector('#dolphinActions tbody');

            watchdogTable.innerHTML = data.watchDogActions.map(botAction => {
                const status = botAction.error ? "Ошибка" : "ОК";
                const errors = Object.entries(botAction.statuses)
                    .filter(([key, value]) => value && value.trim() !== "")
                    .map(([key, value]) => `${key}: ${value} <br>`)
                    .join("");
                return `
                    <tr>
                        <td>${status}</td>
                        <td>${errors}</td>
                        <td>${localTime(botAction.timestamp).toLocaleTimeString()}</td>
                    </tr>
                `
            }).join('');
            
            dolphinTable.innerHTML = data.dolphinActions.map(dolphinAction => {
                return `
                    <tr>
                        <td>OK</td>
                        <td>${localTime(dolphinAction.timestamp).toLocaleTimeString()}</td>
                    </tr>
                `
            }).join('');
        }

        function loadActionsFromHash(){
            const id = location.hash.replace('#', '');
            if (id)
                loadActions(id);
            else if (lastLogDate)
                loadActionsButtonClick(lastLogDate)
        }
        
        document.getElementById('changeBotInfo').addEventListener('submit', async (e) => {
            e.preventDefault();
            const botId = document.getElementById('bot_id').value;
            const res = await fetch('/api/admin/bots/@Model.PcModelId', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ botId })
            });
            if (!res.ok)
            {
                alert("Ошибка при обновлении бота");
                return;
            }
            window.location.href = "";
        });

        window.addEventListener('load', loadActionsFromHash);
        window.addEventListener('hashchange', loadActionsFromHash);
    </script>
    <script>
        const btnWatchdog = document.getElementById('btnWatchdog');
        const btnDolphin = document.getElementById('btnDolphin');
        const tableWatchdog = document.getElementById('watchdogActions');
        const tableDolphin = document.getElementById('dolphinActions');

        btnWatchdog.addEventListener('click', () => {
            tableWatchdog.classList.remove('d-none');
            tableDolphin.classList.add('d-none');

            btnWatchdog.classList.remove('btn-outline-success');
            btnWatchdog.classList.add('btn-success');

            btnDolphin.classList.add('btn-outline-success');
            btnDolphin.classList.remove('btn-success');
        });

        btnDolphin.addEventListener('click', () => {
            tableDolphin.classList.remove('d-none');
            tableWatchdog.classList.add('d-none');

            btnDolphin.classList.remove('btn-outline-success');
            btnDolphin.classList.add('btn-success');
            
            btnWatchdog.classList.add('btn-outline-success');
            btnWatchdog.classList.remove('btn-success');
        });
    </script>
    <script>
        async function loadAgentStatus(){
            const res = await fetch(`/api/admin/agents/@Model.BotId`);
            const data = await res.json();

            const knob = document.querySelector('#statusKnob');
            const text = document.querySelector('#statusText');
            
            if (res.status === 404)
            {
                knob.classList.toggle("bg-secondary", true)
                knob.classList.toggle("bg-danger", false)
                knob.classList.toggle("bg-success", false)
                
                text.innerHTML = "Не появлялся в сети"
            
                return;
            }
            
            if (data.online)
            {
                knob.classList.toggle("bg-secondary", false)
                knob.classList.toggle("bg-danger", false)
                knob.classList.toggle("bg-success", true)
                
                text.innerHTML = "Онлайн"
            }
            else
            {
                knob.classList.toggle("bg-secondary", false)
                knob.classList.toggle("bg-danger", true)
                knob.classList.toggle("bg-success", false)

                text.innerHTML = `Последний онлайн: ${localTime(data.lastSeenUtc).toLocaleString()}`
            }
        }
        
        async function killApps()
        {
            const res = await fetch('/api/admin/agents/@Model.BotId/killApps', {
                method: 'GET'
            });
            
            if(res.status === 404){
                alert("Бот не найден")
                return;
            }
            
            if (res.status === 409)
            {
                alert("Бот оффлайн")
                return;
            }
            
            if (res.ok)
            {
                alert("Успех")
                return
            }
            
            alert("Ошибка при выключении процессов бота")
        }

        loadAgentStatus();
    </script>
}
